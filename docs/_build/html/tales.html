

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tales, Alerts and Actions &mdash; Tattle latest documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Tattle latest documentation" href="index.html"/>
        <link rel="next" title="Tattle Query Language (TQL)" href="tql.html"/>
        <link rel="prev" title="Getting Started - Install &amp; Setup" href="install.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Tattle
          

          
          </a>

          
            
            
              <div class="version">
                1.0.7
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Tattle Intro - Alerting For Your Elasticsearch Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Getting Started - Install &amp; Setup</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tales, Alerts and Actions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-tales">Example Tales</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tale-definitions">Tale Definitions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#name">name</a></li>
<li class="toctree-l3"><a class="reference internal" href="#description">description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#severity">severity</a></li>
<li class="toctree-l3"><a class="reference internal" href="#enabled">enabled</a></li>
<li class="toctree-l3"><a class="reference internal" href="#disabled">disabled</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tql-query">tql_query</a></li>
<li class="toctree-l3"><a class="reference internal" href="#index">index</a></li>
<li class="toctree-l3"><a class="reference internal" href="#schedule">schedule</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exclude-schedule">exclude_schedule</a></li>
<li class="toctree-l3"><a class="reference internal" href="#timeperiod">timeperiod</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exclude">exclude</a></li>
<li class="toctree-l3"><a class="reference internal" href="#alert">alert</a></li>
<li class="toctree-l3"><a class="reference internal" href="#type">type</a></li>
<li class="toctree-l3"><a class="reference internal" href="#relation">relation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#qty">qty</a></li>
<li class="toctree-l3"><a class="reference internal" href="#realert">realert</a></li>
<li class="toctree-l3"><a class="reference internal" href="#return-matches">return_matches</a></li>
<li class="toctree-l3"><a class="reference internal" href="#action">action</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#alert-types">Alert Types</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#frequency">Frequency</a></li>
<li class="toctree-l3"><a class="reference internal" href="#aggregation-match">Aggregation Match</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#alert-actions">Alert Actions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#email">Email</a></li>
<li class="toctree-l3"><a class="reference internal" href="#script">Script</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pager-duty">Pager Duty</a></li>
<li class="toctree-l3"><a class="reference internal" href="#slack">Slack</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#multiple-tales">Multiple Tales</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#syntax">Syntax</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-multi-tale">Example Multi Tale</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tql.html">Tattle Query Language (TQL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Tattle</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Tales, Alerts and Actions</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/tales.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tales-alerts-and-actions">
<h1>Tales, Alerts and Actions<a class="headerlink" href="#tales-alerts-and-actions" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Tales are the heart and soul of the system.  Tales are definitions for alerts and define such things as our time window for the events we seek, what query will run, thresholds, actions to take, etc.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Tales are  kept in <cite>yaml</cite> files in <code class="docutils literal"><span class="pre">$TATTLE_HOME/etc/tattle/tales</span></code>, <code class="docutils literal"><span class="pre">$TATTLE_HOME/etc/tales</span></code> or in <code class="docutils literal"><span class="pre">$TATTLE_HOME/etc/alerts</span></code>.</p>
</div>
<p>To understand <cite>Tales</cite>, lets take a look at an example below.  Please note, we will use this as a reference for the rest of the Tales documentation.</p>
</div>
<div class="section" id="example-tales">
<h2>Example Tales<a class="headerlink" href="#example-tales" title="Permalink to this headline">¶</a></h2>
<p>In this example, we will be finding all hosts in our environment that have a disk usage of <cite>greater than or equal</cite> to <cite>90%</cite> for the past <cite>1 hour</cite>.  When a match is found, it will send us an alert via Pagerduty as well as an email for each <cite>key</cite> ( host in this case ) that was matched.</p>
<p>TQL Query with multiple aggregations and multiple actions example</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Disk Usage over 90 %&quot;</span>
<span class="n">description</span><span class="p">:</span> <span class="s2">&quot;Disk Usage High on a host or series of hosts&quot;</span>
<span class="n">severity</span><span class="p">:</span> <span class="s2">&quot;High&quot;</span>
<span class="n">tql_query</span><span class="p">:</span> <span class="s2">&quot;summary.fullest_disk:&gt;=90 | terms name=server, field=host.raw | avg name=fullest_disk, field=summary.fullest_disk&quot;</span>
<span class="n">exclude</span><span class="p">:</span> <span class="s1">&#39;host.raw:database4.mycompany.com&#39;</span>
<span class="n">index</span><span class="p">:</span> <span class="s2">&quot;system-metrics-*&quot;</span>
<span class="n">enabled</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">schedule</span><span class="p">:</span> <span class="s1">&#39;* 8-18 * * mon-fri&#39;</span>
<span class="n">exclude_schedule</span><span class="p">:</span> <span class="s1">&#39;30 12 * * *</span>
<span class="n">timeperiod</span><span class="p">:</span>
    <span class="n">start</span><span class="p">:</span> <span class="s2">&quot;now-1h&quot;</span>
    <span class="n">end</span><span class="p">:</span> <span class="s2">&quot;now&quot;</span>
<span class="n">alert</span><span class="p">:</span>
    <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;frequency&quot;</span>
    <span class="n">relation</span><span class="p">:</span> <span class="s2">&quot;gt&quot;</span>
    <span class="n">qty</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">realert</span><span class="p">:</span> <span class="s2">&quot;4h&quot;</span>
    <span class="n">return_matches</span><span class="p">:</span>
        <span class="n">length</span><span class="p">:</span> <span class="mi">10</span>
        <span class="n">random</span><span class="p">:</span> <span class="n">true</span>
<span class="n">action</span><span class="p">:</span>
    <span class="n">pagerduty</span><span class="p">:</span>
        <span class="n">enabled</span><span class="p">:</span> <span class="mi">1</span>
        <span class="n">service_key</span><span class="p">:</span> <span class="s2">&quot;TattleAlerts&quot;</span>
        <span class="n">once_per_match</span><span class="p">:</span>
            <span class="n">match_key</span><span class="p">:</span> <span class="s2">&quot;key&quot;</span>

    <span class="n">email</span><span class="p">:</span>
        <span class="n">enabled</span><span class="p">:</span> <span class="mi">1</span>
        <span class="n">once_per_match</span><span class="p">:</span>
            <span class="n">match_key</span><span class="p">:</span> <span class="s2">&quot;key&quot;</span>
        <span class="n">to</span><span class="p">:</span>
            <span class="o">-</span> <span class="s1">&#39;my_email@company.com&#39;</span>
            <span class="o">-</span> <span class="s1">&#39;alerts@company.com&#39;</span>
</pre></div>
</div>
<p>For more breakdown on this Tale, lets look at the <a class="reference internal" href="#tales-definitions"><span class="std std-ref">Tale Definitions</span></a> section.</p>
</div>
<div class="section" id="tale-definitions">
<span id="tales-definitions"></span><h2>Tale Definitions<a class="headerlink" href="#tale-definitions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="name">
<h3>name<a class="headerlink" href="#name" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>Required: <cite>Yes</cite></li>
<li>Description: Name of the alert</li>
</ul>
</div></blockquote>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>name: &quot;Disk Usage &gt;= 90%&quot;``
</pre></div>
</div>
</div>
<div class="section" id="description">
<h3>description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>Required: <cite>Yes</cite></li>
<li>Description: A brief description of the tale.</li>
</ul>
</div></blockquote>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">description</span><span class="p">:</span> <span class="s2">&quot;The disk usage on the server &gt;= 90</span><span class="si">% o</span><span class="s2">n the root filesystem``</span>
</pre></div>
</div>
</div>
<div class="section" id="severity">
<h3>severity<a class="headerlink" href="#severity" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>Required: <cite>No</cite></li>
<li>Description: The severity of the alert.  This is a string, and can be whatever you want.  1-5, Low-Crit, etc</li>
</ul>
</div></blockquote>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">severity</span><span class="p">:</span> <span class="s2">&quot;High&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="enabled">
<h3>enabled<a class="headerlink" href="#enabled" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>Required: <cite>Yes</cite></li>
<li>Description: Whteher this Tale is enabled (1)(True) or disabled (0)(False)</li>
</ul>
</div></blockquote>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># This alert is enabled</span>
<span class="n">enabled</span><span class="p">:</span> <span class="mi">1</span>
<span class="c1"># This alert is disabled</span>
<span class="n">enabled</span><span class="p">:</span> <span class="mi">0</span>
<span class="c1"># You can even use strings</span>
<span class="n">enabled</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span>
<span class="c1"># Or True and False Statements</span>
<span class="n">enabled</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
</div>
<div class="section" id="disabled">
<h3>disabled<a class="headerlink" href="#disabled" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>Required: <cite>Yes</cite> but only if you didnt specify an <code class="docutils literal"><span class="pre">enabled</span></code></li>
<li>Description:  The same thing as as <code class="docutils literal"><span class="pre">enabled</span></code> above, but with opposite logic.  Tattle used to use the term <code class="docutils literal"><span class="pre">disabled</span></code> instead of <code class="docutils literal"><span class="pre">enabled</span></code>, but this old method is left in for legacy support.  Please use the <code class="docutils literal"><span class="pre">enabled</span></code> term going forward with new Tales.</li>
</ul>
</div></blockquote>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># This alert is enabled, not disabled</span>
<span class="n">disabled</span><span class="p">:</span> <span class="mi">0</span>
<span class="c1"># this alert is disabled</span>
<span class="n">disabled</span><span class="p">:</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="section" id="tql-query">
<h3>tql_query<a class="headerlink" href="#tql-query" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>Required: <cite>Yes</cite></li>
<li>Description: The TQL query for the Tale.  See the <a class="reference internal" href="tql.html"><span class="doc">Tattle Query Language (TQL)</span></a> page for more details on TQL</li>
</ul>
</div></blockquote>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">tql_query</span><span class="p">:</span> <span class="s2">&quot;summary.fullest_disk:&gt;=90 | terms name=server, field=host.raw | avg name=fullest_disk, field=summary.fullest_disk&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="index">
<h3>index<a class="headerlink" href="#index" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul>
<li><p class="first">Required <cite>Yes</cite></p>
</li>
<li><p class="first">Description: The index pattern where you the events you are searching reside.  Default is <code class="docutils literal"><span class="pre">logstash-*</span></code></p>
</li>
<li><dl class="first docutils">
<dt>More information:</dt>
<dd><ul class="first last">
<li><dl class="first docutils">
<dt>Builds the index names that Tattle will search data against</dt>
<dd><ul class="first last simple">
<li>It uses the  <code class="docutils literal"><span class="pre">start</span></code> and <code class="docutils literal"><span class="pre">end</span></code> time in <code class="docutils literal"><span class="pre">timeperiod</span></code> of the Tale to determine which indexes to build/query against.</li>
</ul>
</dd>
</dl>
</li>
<li><p class="first">Its common to store <cite>timeseries</cite> based indexes in Elasticsearch.  The most common format is store your data by day and append a date timestamp at the end of index.  The most common format is <code class="docutils literal"><span class="pre">YYYY.MM.DD</span></code>.  If you specify a <code class="docutils literal"><span class="pre">*</span></code> at the end of the index pattern in Tattle, ie <code class="docutils literal"><span class="pre">logstash-*</span></code>, then Tattle will build the indexs for you by <code class="docutils literal"><span class="pre">day</span></code> when it does its search.</p>
</li>
<li><p class="first">If you store your indexes in a different time pattern or interval other than daily, then you can specify the time pattern and interval.  See examples 2-4</p>
</li>
<li><p class="first">If you done specify a pattern or interval or a <code class="docutils literal"><span class="pre">*</span></code>, then Tattle will search just that single index.</p>
</li>
<li><p class="first">For more information on the tokens allowd for the patterns, please see the documentation for <a class="reference external" href="http://crsmithdev.com/arrow/#tokens">Arrow</a>.</p>
</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p>Example 1:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">index</span><span class="p">:</span> <span class="s2">&quot;system-metrics-*&quot;</span>
</pre></div>
</div>
<p>Makes index names similar to:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">system</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="mf">2016.01</span><span class="o">.</span><span class="mi">01</span><span class="p">,</span> <span class="n">system</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="mf">2016.12</span><span class="o">.</span><span class="mi">29</span> <span class="o">....</span> <span class="n">etc</span>
</pre></div>
</div>
<p>Example 2 - specifying pattern and interval:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">index</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;system-metrics-&quot;</span>
    <span class="n">pattern</span><span class="p">:</span> <span class="s2">&quot;YYYY.MM.DD&quot;</span>
    <span class="n">interval</span><span class="p">:</span> <span class="s2">&quot;day&quot;</span>
</pre></div>
</div>
<p>This would give us index names such as:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">system</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="mf">2016.01</span><span class="o">.</span><span class="mi">01</span><span class="p">,</span> <span class="n">system</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="mf">2015.12</span><span class="o">.</span><span class="mi">29</span><span class="p">,</span> <span class="n">etc</span>
</pre></div>
</div>
<p>Example 3 - specifying pattern as string:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">index</span><span class="p">:</span> <span class="s2">&quot;system-metrics-%{+YYYY.MM.DD}</span>
</pre></div>
</div>
<p>This would give us the same index names as Example 1 and 2
Example 4 - specifying pattern and interval as a string, not the interval at the end of the string after the <code class="docutils literal"><span class="pre">:</span></code> :</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">index</span><span class="p">:</span> <span class="s2">&quot;system-metrics-%{+YYYY.MM.DD.HH}:hour&quot;</span>
</pre></div>
</div>
<p>Valid intervals are python datetime - <code class="docutils literal"><span class="pre">year</span></code>, <code class="docutils literal"><span class="pre">month</span></code>, <code class="docutils literal"><span class="pre">week</span></code>, <code class="docutils literal"><span class="pre">day</span></code>, <code class="docutils literal"><span class="pre">hour</span></code>, <code class="docutils literal"><span class="pre">second</span></code>
This would build index names with hour intervals such as:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">some</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="mf">2015.12</span><span class="o">.</span><span class="mf">29.00</span><span class="p">,</span><span class="n">some</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="mf">2015.12</span><span class="o">.</span><span class="mf">29.01</span><span class="p">,</span><span class="n">some</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="mf">2015.12</span><span class="o">.</span><span class="mf">29.02</span><span class="p">,</span><span class="n">some</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="mf">2015.12</span><span class="o">.</span><span class="mf">29.03</span><span class="p">,</span><span class="n">some</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="mf">2015.12</span><span class="o">.</span><span class="mf">29.04</span><span class="p">,</span><span class="n">some</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="mf">2015.12</span><span class="o">.</span><span class="mf">29.05</span><span class="p">,</span><span class="n">some</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="mf">2015.12</span><span class="o">.</span><span class="mf">29.06</span><span class="p">,</span><span class="n">some</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="mf">2015.12</span><span class="o">.</span><span class="mf">29.07</span><span class="p">,</span> <span class="o">...</span> <span class="n">etc</span>
</pre></div>
</div>
</div>
<div class="section" id="schedule">
<h3>schedule<a class="headerlink" href="#schedule" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>Required <cite>No</cite></li>
<li>Description: Specifies when a Tale should run, using cron syntax.</li>
<li>More Information: Sometimes you may only want to have a Tale run during business hours ( 8am - 6pm , mon-fri ).  This allows you to specify when this Tale will run in cron format ( see example below )</li>
<li>Credit:  This is using the parse-crontab module by Josiah Carlson which can be found <a class="reference external" href="https://github.com/josiahcarlson/parse-crontab">here</a></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you do not specify a <code class="docutils literal"><span class="pre">schedule</span></code> for your Tale, then Tattle will run this Tale every time it runs.</p>
</div>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">schedule</span><span class="p">:</span> <span class="s2">&quot;* 8-18 * * mon-fri&quot;</span>
</pre></div>
</div>
<p>Cron Examples:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>30 \*/2 * * * -&gt; 30 minutes past the hour every 2 hours
15,45 23 * * * -&gt; 11:15PM and 11:45PM every day
0 1 ? * SUN -&gt; 1AM every Sunday
0 1 * * SUN -&gt; 1AM every Sunday (same as above)
0 0 1 jan/2 * 2011-2013 -&gt; midnight on January 1, 2011 and the first of every odd month until the end of 2013
24 7 L * * -&gt; 7:24 AM on the last day of every month
24 7 * * L5 -&gt; 7:24 AM on the last friday of every month
24 7 * * Lwed-fri -&gt; 7:24 AM on the last wednesday, thursday, and friday of every month
</pre></div>
</div>
</div>
<div class="section" id="exclude-schedule">
<h3>exclude_schedule<a class="headerlink" href="#exclude-schedule" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>Required <cite>No</cite></li>
<li>Description: Allows you to specify a time period for when this Tale will not run, in cron format.  This would be the opposite of the <code class="docutils literal"><span class="pre">schedule</span></code> option</li>
<li>More information:  Lets say you have a something that runs every saturday and sunday morning between 4am and 7am.  You know its normal so you dont want to be alerted about it, but any other time you do.  This parameter allows you to specify a window for Tale to not run at.</li>
<li>Credit:  This is using the parse-crontab module by Josiah Carlson which can be found <a class="reference external" href="https://github.com/josiahcarlson/parse-crontab">here</a></li>
</ul>
</div></blockquote>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">exclude_schedule</span><span class="p">:</span> <span class="s1">&#39;* 4-7 * sat * &#39;</span>
</pre></div>
</div>
<p>Cron Examples:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>30 \*/2 * * * -&gt; 30 minutes past the hour every 2 hours
15,45 23 * * * -&gt; 11:15PM and 11:45PM every day
0 1 ? * SUN -&gt; 1AM every Sunday
0 1 * * SUN -&gt; 1AM every Sunday (same as above)
0 0 1 jan/2 * 2011-2013 -&gt; midnight on January 1, 2011 and the first of every odd month until the end of 2013
24 7 L * * -&gt; 7:24 AM on the last day of every month
24 7 * * L5 -&gt; 7:24 AM on the last friday of every month
24 7 * * Lwed-fri -&gt; 7:24 AM on the last wednesday, thursday, and friday of every month
</pre></div>
</div>
</div>
<div class="section" id="timeperiod">
<h3>timeperiod<a class="headerlink" href="#timeperiod" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul>
<li><p class="first"><code class="docutils literal"><span class="pre">start</span></code>, <code class="docutils literal"><span class="pre">end</span></code></p>
</li>
<li><p class="first">Required: <cite>Yes</cite></p>
</li>
<li><p class="first">Description: The timeperiod for events this Tale searches for.  This is a rolling window using python-datemath as our start and end times.</p>
</li>
<li><dl class="first docutils">
<dt>More information:</dt>
<dd><ul class="first last simple">
<li>More documentation on python-datemath can be found here: <a class="reference external" href="https://github.com/nickmaccarthy/python-datemath">https://github.com/nickmaccarthy/python-datemath</a></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">timeperiod</span><span class="p">:</span>
    <span class="c1"># The start of our alert window</span>
    <span class="n">start</span><span class="p">:</span> <span class="s1">&#39;now-1h&#39;</span>
    <span class="c1"># The end of our alert window</span>
    <span class="n">end</span><span class="p">:</span> <span class="s1">&#39;now&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="exclude">
<h3>exclude<a class="headerlink" href="#exclude" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>Required: <cite>No</cite></li>
<li>Description: Allows you to specify query parameters to exclude form this Tale</li>
<li>More information:  For this example, lets say we dont want to see alerts for the host <code class="docutils literal"><span class="pre">database4.company.com</span></code> because its supposed to have a full disk, we can use this to parameter to exclude that host from the tale.  This parameter accepts Lucne query syntax</li>
</ul>
</div></blockquote>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">host</span><span class="p">:</span><span class="n">database4</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">com</span> <span class="n">OR</span> <span class="n">host</span><span class="p">:</span><span class="n">database5</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
</div>
<div class="section" id="alert">
<h3>alert<a class="headerlink" href="#alert" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="type">
<h3>type<a class="headerlink" href="#type" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul>
<li><p class="first">Required: <cite>Yes</cite></p>
</li>
<li><p class="first">Description: The type of the alert</p>
</li>
<li><dl class="first docutils">
<dt>Values</dt>
<dd><ul class="first last">
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">frequency</span></code> or <code class="docutils literal"><span class="pre">number_of_events</span></code></dt>
<dd><ul class="first last simple">
<li>Description: If the <cite>number of events</cite> meets our <code class="docutils literal"><span class="pre">relation</span></code> and <code class="docutils literal"><span class="pre">qty</span></code></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">agg_match</span></code></dt>
<dd><ul class="first last simple">
<li>Description: If our value meets a regular expression match of something</li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="relation">
<h3>relation<a class="headerlink" href="#relation" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul>
<li><p class="first">Required: <cite>Yes</cite></p>
</li>
<li><p class="first">Description: If our event count meets our relation, then the alert should fire</p>
</li>
<li><dl class="first docutils">
<dt>Values</dt>
<dd><ul class="first last simple">
<li><code class="docutils literal"><span class="pre">eq</span></code>, <code class="docutils literal"><span class="pre">=</span></code> - Equal To</li>
<li><code class="docutils literal"><span class="pre">ne</span></code>, <code class="docutils literal"><span class="pre">!=</span></code> - Not Equal To</li>
<li><code class="docutils literal"><span class="pre">lt</span></code>, <code class="docutils literal"><span class="pre">&lt;</span></code> - Less Than</li>
<li><code class="docutils literal"><span class="pre">gt</span></code>, <code class="docutils literal"><span class="pre">&gt;</span></code> - Greater Than</li>
<li><code class="docutils literal"><span class="pre">le</span></code>, <code class="docutils literal"><span class="pre">&lt;=</span></code> - Less Than or Equal To</li>
<li><code class="docutils literal"><span class="pre">ge</span></code>, <code class="docutils literal"><span class="pre">&gt;=</span></code> - Greater Than or Equal To</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="qty">
<h3>qty<a class="headerlink" href="#qty" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>Required: <cite>Yes</cite></li>
<li>Description: What we compare our <code class="docutils literal"><span class="pre">relation</span></code> to</li>
</ul>
</div></blockquote>
<p>Example&#8221;:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">## If our number of events is greater than or equal to 10, then we should alert</span>
<span class="n">relation</span><span class="p">:</span> <span class="s2">&quot;&gt;=&quot;</span>
<span class="n">qty</span><span class="p">:</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
<div class="section" id="realert">
<h3>realert<a class="headerlink" href="#realert" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul>
<li><p class="first">Required: <cite>Yes</cite></p>
</li>
<li><p class="first">Description:  How long Tattle will wait before it will re-alert on this Tale.  If Tattle is still finding matches for this Tale, but we are within the re-alert threshold, then Tattle will not alert.</p>
</li>
<li><dl class="first docutils">
<dt>Notes:</dt>
<dd><ul class="first last">
<li><p class="first">Every time Tattle fires an alert, it stores it in the Tattle index in Elasticserach ( default is <code class="docutils literal"><span class="pre">tattle-int</span></code> ).  When the Tale gets loaded, one of the first thing it does it check to see when the last time this Tale fired.  It then compares the last time to the realert threshold, diffs the two and if we are beyone our re-alert threshold, then Tattle will re-fire the Tale.</p>
</li>
<li><dl class="first docutils">
<dt>It uses simple datemath like so:</dt>
<dd><ul class="first last simple">
<li><code class="docutils literal"><span class="pre">1h</span></code></li>
<li><code class="docutils literal"><span class="pre">2m</span></code></li>
<li><code class="docutils literal"><span class="pre">3d</span></code></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Don&#39;t alert us to this again for 1 hour</span>
<span class="n">realert</span><span class="p">:</span> <span class="s2">&quot;1h&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="return-matches">
<h3>return_matches<a class="headerlink" href="#return-matches" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul>
<li><p class="first">Required: <cite>Yes</cite></p>
</li>
<li><p class="first">Description:  If Tattle should return the matches it found.  It will return those matches in whatever action you have configured</p>
</li>
<li><dl class="first docutils">
<dt>Notes:</dt>
<dd><ul class="first last simple">
<li>Sometimes you can get many matches ( hundreds or thousands for example ).  With the <code class="docutils literal"><span class="pre">random:</span> <span class="pre">True</span></code> or <code class="docutils literal"><span class="pre">length:</span> <span class="pre">10</span></code> stanzas Tattle can return a randam sample of <code class="docutils literal"><span class="pre">10</span></code> results</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Assuming we could get hundreds of matches back</span>
<span class="n">return_matches</span><span class="p">:</span>
    <span class="c1"># Return back a random sample of 20 results</span>
    <span class="n">random</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">length</span><span class="p">:</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
<div class="section" id="action">
<h3>action<a class="headerlink" href="#action" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="alert-types">
<h2>Alert Types<a class="headerlink" href="#alert-types" title="Permalink to this headline">¶</a></h2>
<div class="section" id="frequency">
<h3>Frequency<a class="headerlink" href="#frequency" title="Permalink to this headline">¶</a></h3>
<p>Frequency alerts occur when a certain number of events ( as defined by <code class="docutils literal"><span class="pre">relation</span></code> and <code class="docutils literal"><span class="pre">qty</span></code>) occur within a certain period of time.</p>
<p>Here are some examples:</p>
<ul class="simple">
<li>&#8220;20 or more failed login events with in the past 1 hour&#8221;</li>
</ul>
<p>Example</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Too many login failures&quot;</span>
<span class="n">tql_query</span><span class="p">:</span> <span class="s1">&#39;&quot;failed login&quot;&#39;</span>
<span class="n">index</span><span class="p">:</span> <span class="s2">&quot;secure-log-*&quot;</span>
<span class="n">timeperiod</span><span class="p">:</span>
    <span class="n">start</span><span class="p">:</span> <span class="s2">&quot;now-1h&quot;</span>
    <span class="n">end</span><span class="p">:</span> <span class="s2">&quot;now&quot;</span>
<span class="n">alert</span><span class="p">:</span>
    <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;frequency&quot;</span>
    <span class="n">qty</span><span class="p">:</span> <span class="mi">20</span>
    <span class="n">relation</span><span class="p">:</span> <span class="s2">&quot;&gt;=&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li>&#8220;300 or more Nginx logs with an error code of 502 in the last 1 minute&#8221;</li>
</ul>
<p>Example</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">name</span><span class="p">:</span> <span class="s2">&quot;NGINX 502 errors&quot;</span>
<span class="n">tql_query</span><span class="p">:</span> <span class="s2">&quot;status:502 | terms field=hostname&quot;</span>
<span class="n">index</span><span class="p">:</span> <span class="s2">&quot;nginx-access-*&quot;</span>
<span class="n">timeperiod</span><span class="p">:</span>
    <span class="n">start</span><span class="p">:</span> <span class="s2">&quot;now-1m&quot;</span>
    <span class="n">end</span><span class="p">:</span> <span class="s2">&quot;now&quot;</span>
<span class="n">alert</span><span class="p">:</span>
    <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;frequency&quot;</span>
    <span class="n">qty</span><span class="p">:</span> <span class="mi">300</span>
    <span class="n">relation</span><span class="p">:</span> <span class="s2">&quot;&gt;=&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li>&#8220;Less than 1000 events on all of our NGINX logs for the past 1 hour&#8221;</li>
</ul>
<p>Example</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Low event count on NGINX, possible log outage&quot;</span>
<span class="n">tql_query</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
<span class="n">index</span><span class="p">:</span> <span class="s2">&quot;nginx-access-*&quot;</span>
<span class="n">timeperiod</span><span class="p">:</span>
    <span class="n">start</span><span class="p">:</span> <span class="s2">&quot;now-1h&quot;</span>
    <span class="n">end</span><span class="p">:</span> <span class="s2">&quot;now&quot;</span>
<span class="n">alert</span><span class="p">:</span>
    <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;frequency&quot;</span>
    <span class="n">qty</span><span class="p">:</span> <span class="mi">1000</span>
    <span class="n">relation</span><span class="p">:</span> <span class="s2">&quot;le&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="aggregation-match">
<h3>Aggregation Match<a class="headerlink" href="#aggregation-match" title="Permalink to this headline">¶</a></h3>
<p>Agg Match alerts are useful for aggregation based alerts where the keys and values can change depending on your data.  Often times the result of most metric based aggregtions will a field called <code class="docutils literal"><span class="pre">value</span></code>.  This type of alert type can use a regular expression to match the value and compare it to our <code class="docutils literal"><span class="pre">qty</span></code> and <code class="docutils literal"><span class="pre">relation</span></code> fields</p>
<p>When you use an agg_match, Tattle will flatten the aggregation returned so it can be iterated against and matched by a regular expression.</p>
<p>Take this example a return</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;max_score&quot;</span><span class="p">:</span> <span class="mf">0.0</span>
    <span class="p">},</span>
    <span class="s2">&quot;_shards&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;successful&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">5</span>
    <span class="p">},</span>
    <span class="s2">&quot;took&quot;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span>
    <span class="s2">&quot;aggregations&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;terms&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;buckets&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;avg&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">90.8</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;someserver1.somecompany.net&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;doc_count&quot;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;avg&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">93.5</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;someserver2.somecompany.net&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;doc_count&quot;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;sum_other_doc_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;doc_count_error_upper_bound&quot;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;timed_out&quot;</span><span class="p">:</span> <span class="n">false</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Tattle would flatten the aggregations section this to</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">aggregations</span><span class="o">.</span><span class="n">terms</span><span class="o">.</span><span class="n">buckets</span><span class="o">.</span><span class="mf">0.</span><span class="n">avg</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">90.8</span>
<span class="n">aggregations</span><span class="o">.</span><span class="n">terms</span><span class="o">.</span><span class="n">buckets</span><span class="o">.</span><span class="mf">0.</span><span class="n">key</span> <span class="o">=</span> <span class="n">someserver1</span><span class="o">.</span><span class="n">somecompany</span><span class="o">.</span><span class="n">net</span>
<span class="n">aggregations</span><span class="o">.</span><span class="n">terms</span><span class="o">.</span><span class="n">buckets</span><span class="o">.</span><span class="mf">1.</span><span class="n">avg</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">93.5</span>
<span class="n">aggregations</span><span class="o">.</span><span class="n">terms</span><span class="o">.</span><span class="n">buckets</span><span class="o">.</span><span class="mf">1.</span><span class="n">key</span> <span class="o">=</span> <span class="n">someserver2</span><span class="o">.</span><span class="n">somecompany</span><span class="o">.</span><span class="n">net</span>
</pre></div>
</div>
<p>So if we wanted to look for any <cite>values</cite> in our aggs that are <code class="docutils literal"><span class="pre">&gt;=</span> <span class="pre">90</span></code> we would use the regular expression <code class="docutils literal"><span class="pre">^.value$</span></code> as our match key.</p>
<p>Some examples</p>
<p>Basic example where we look for any <cite>value</cite> that is <code class="docutils literal"><span class="pre">&gt;=</span></code> <cite>90</cite></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">alert</span><span class="p">:</span>
    <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;agg_match&quot;</span>
    <span class="n">field</span><span class="p">:</span> <span class="s1">&#39;^.*value$&#39;</span>
    <span class="n">relation</span><span class="p">:</span> <span class="s2">&quot;&gt;=&quot;</span>
    <span class="n">qty</span><span class="p">:</span> <span class="mi">90</span>
</pre></div>
</div>
<p>Or if we wanted to only look at only the first bucket, for a value <code class="docutils literal"><span class="pre">&gt;=</span> <span class="pre">20</span></code></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">alert</span><span class="p">:</span>
    <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;agg_match&quot;</span>
    <span class="n">field</span><span class="p">:</span> <span class="s1">&#39;^\.buckets\.0.*value$&#39;</span>
    <span class="n">relation</span><span class="p">:</span> <span class="s2">&quot;&gt;=&quot;</span>
    <span class="n">qty</span><span class="p">:</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="alert-actions">
<h2>Alert Actions<a class="headerlink" href="#alert-actions" title="Permalink to this headline">¶</a></h2>
<p>Actions are what is taken after the Tale has met its alert threshold.</p>
<p>You can also have multiple actions per Tale. In our example Tale, you can we have two actions configured, one to send Emails, and one to send the alerts to Pager Duty as well.</p>
<div class="section" id="email">
<h3>Email<a class="headerlink" href="#email" title="Permalink to this headline">¶</a></h3>
<p>Probably the most common alert action.  Tattle sends a formatted, HTML email to recipient(s)</p>
<p>The email server properties are stored in <code class="docutils literal"><span class="pre">$TATTLE_HOME/etc/tattle/tattle.yaml</span></code>, so please set that up first before you proceed with email alerts</p>
<p>Tale Examples:</p>
<p>Example</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">action</span><span class="p">:</span>
    <span class="n">email</span><span class="p">:</span>
        <span class="c1"># Optional - We can enable or disable this action with this flag</span>
        <span class="n">enabled</span><span class="p">:</span> <span class="mi">1</span>
        <span class="c1"># Required - Who the email should go to</span>
        <span class="n">to</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;alerts@company.com&#39;</span><span class="p">,</span> <span class="s1">&#39;manager@company.com&#39;</span> <span class="p">]</span>
        <span class="c1"># Optional - If we should send a sperate email for every match.  If this is not set, then the all of the results are sent in one email</span>
        <span class="n">once_per_match</span><span class="p">:</span>
            <span class="c1"># The match key, is the part of the result we use our primary key for sperating the results in seperate emails</span>
            <span class="c1"># In this case its &quot;key&quot; since its the key of the aggregation.  In our case this will be the hostname</span>
            <span class="c1"># If we had 4 hosts that matched then we would have 4 seperate emails.  Tattle will append the &#39;match_key&#39; to the subject of the email as well</span>
            <span class="n">match_key</span><span class="p">:</span> <span class="s2">&quot;key&quot;</span>
        <span class="c1"># Optional - A link to a external url to be shown in the email</span>
        <span class="n">client_url</span><span class="p">:</span> <span class="s1">&#39;https://someapp.company.com&#39;</span>
        <span class="c1"># Optional - kibana4_dashbaord to link to a kibana dashbaord.  When using this, Tattle will add the times from the Tale into the dashboard link, note this works for kibana4 dashbaords only</span>
        <span class="n">kibana4_dashboard</span><span class="p">:</span> <span class="s1">&#39;http://kibana.company.com/app/kibana#/dashboard/OurAwesomeDashboard&#39;</span>
</pre></div>
</div>
<p>If you want to change the HTML for the email, add company logos etc, you can change the templates directly in <code class="docutils literal"><span class="pre">$TATTLE_HOME/use/share/templates/html/email.html</span></code></p>
</div>
<div class="section" id="script">
<h3>Script<a class="headerlink" href="#script" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">script</span></code> alert action allows you to specify a script to run when the alert is fired/triggerd.  When Tattle fires off the script, it passes in the results from the alert, the Tale definition, and the TQL query intentions for use within the script.</p>
<p>When the script is called, three arguments are passed in to, each argument will contain JSON as its data.</p>
<dl class="docutils">
<dt>Arguments</dt>
<dd><ul class="first last simple">
<li><code class="docutils literal"><span class="pre">$1</span></code> - The results, or matches from the alert</li>
<li><code class="docutils literal"><span class="pre">$2</span></code> - The Tale details that was responsible for triggering this alert</li>
<li><code class="docutils literal"><span class="pre">$3</span></code> - The TQL Query intentions</li>
</ul>
</dd>
</dl>
<p>Your script must be in <code class="docutils literal"><span class="pre">$TATTLE_HOME/bin/scripts</span></code> and must be executable.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The script will run as whatever user Tattle runs as.  For example if you run Tattle under a user called <cite>tattle</cite>, then the script will run as the user <cite>tattle</cite>.</p>
</div>
<p>Here is an example script that will echo out each of the ARGV&#8217;s</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>#!/bin/bash
echo &#39;RESULTS:&#39;
echo $1

echo &#39;TALE:&#39;
echo $2

echo &#39;INTENTIONS:&#39;
echo $3
</pre></div>
</div>
</div>
<div class="section" id="pager-duty">
<h3>Pager Duty<a class="headerlink" href="#pager-duty" title="Permalink to this headline">¶</a></h3>
<p>Another very common use for Tattle is to send its alert direclty to Pager Duty.</p>
<p>Pager Duty alerts can be setup to Service Key, as defined in Pager Duty itself.  The service Key definitions can be stored in the <code class="docutils literal"><span class="pre">$TATTLE_HOME/etc/tattle/pagerduty.yaml</span></code> and can be referenced in the action by thier title.</p>
<p>Example <code class="docutils literal"><span class="pre">$TATTLEHOME/etc/tattle/pagerduty.yaml</span></code></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">TattleAlerts</span><span class="p">:</span>
    <span class="n">service_key</span><span class="p">:</span> <span class="s2">&quot;&lt;service key&gt;&quot;</span>
<span class="n">DataSystems</span><span class="p">:</span>
    <span class="n">service_key</span><span class="p">:</span> <span class="s2">&quot;&lt;service_key&gt;&quot;</span>
<span class="n">WebSystem</span><span class="p">:</span>
    <span class="n">service_key</span><span class="p">:</span> <span class="s2">&quot;&lt;service_key&gt;&quot;</span>
</pre></div>
</div>
<p>Example Tale action</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">action</span><span class="p">:</span>
    <span class="n">pagerduty</span><span class="p">:</span>
        <span class="c1"># Optional - We can enable or disable this action here</span>
        <span class="n">enabled</span><span class="p">:</span> <span class="mi">1</span>
        <span class="c1"># Required - The name of the service key to use, as defined in pagerduty.yaml</span>
        <span class="n">service_key</span><span class="p">:</span> <span class="s2">&quot;TattleAlerts&quot;</span>
        <span class="c1"># Optional - The URL to specify for the &#39;View In&#39; part of Pagerduty.  This could be Kibana dashboard or any web application you wish</span>
        <span class="n">client_url</span><span class="p">:</span> <span class="s2">&quot;https://kibana.company.com/app/kibana#/dashboard/OurAwesomeDashboard&quot;</span>
        <span class="c1"># Optional - kibana4_dashbaord to link to a kibana dashbaord which will be shown in &#39;View In&#39;.  When using this, Tattle will add the times from the Tale into the dashboard link, note this works for kibana4 dashbaords only</span>
        <span class="n">kibana4_dashboard</span><span class="p">:</span> <span class="s1">&#39;http://kibana.company.com/app/kibana#/dashboard/OurAwesomeDashboard&#39;</span>
        <span class="c1"># Optional - If we should compile seperate pagerduty alerts for each match.  If this is not set, then the all of the results are sent in one PD alert</span>
        <span class="n">once_per_match</span><span class="p">:</span>
            <span class="c1"># The match key, is the part of the result we use our primary key for sperating the results in seperate PD alerts</span>
            <span class="c1"># In this case its &quot;key&quot; since its the key of the aggregation.  In our case this will be the hostname</span>
            <span class="c1"># If we had 4 hosts that matched then we would have 4 seperate Pagerduty alerts.  Tattle will append the &#39;match_key&#39; to the subject of the Pagerduty alert as well</span>
            <span class="n">match_key</span><span class="p">:</span> <span class="s2">&quot;key&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="slack">
<h3>Slack<a class="headerlink" href="#slack" title="Permalink to this headline">¶</a></h3>
<p>You can post Tattle alerts into Slack</p>
<p>To use this, all you need to do is add the <code class="docutils literal"><span class="pre">webhook_url</span></code> and <code class="docutils literal"><span class="pre">channel</span></code> in your Tale <code class="docutils literal"><span class="pre">action</span></code></p>
<p>Example</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">action</span><span class="p">:</span>
    <span class="n">slack</span><span class="p">:</span>
        <span class="c1"># Optional - if the action is enabled or not ( default is True )</span>
        <span class="n">enabled</span><span class="p">:</span> <span class="mi">1</span>
        <span class="c1"># Required - The webhook url to use for the slack intergration</span>
        <span class="n">webhook_url</span><span class="p">:</span> <span class="s1">&#39;https://hooks.slack.com/services/TTAsdfQ/asdfasdf/asdfasdfasdf&#39;</span>
        <span class="c1"># Required - the slack channel to post the alert to</span>
        <span class="n">channel</span><span class="p">:</span> <span class="s1">&#39;engineering-channel&#39;</span>
        <span class="n">once_per_match</span><span class="p">:</span> <span class="c1"># Optional</span>
            <span class="c1"># The match key, is the part of the result we use our primary key for sperating the results in seperate PD alerts</span>
            <span class="c1"># In this case its &quot;key&quot; since its the key of the aggregation.  In our case this will be the hostname</span>
            <span class="c1"># If we had 4 hosts that matched then we would have 4 seperate Pagerduty alerts.  Tattle will append the &#39;match_key&#39; to the subject of the Pagerduty alert as well</span>
            <span class="n">match_key</span><span class="p">:</span> <span class="s2">&quot;key&quot;</span>
        <span class="c1"># optional - A link to a external url which will be displayed in the Title of the Slack alert</span>
        <span class="n">client_url</span><span class="p">:</span> <span class="s1">&#39;https://someapp.company.com&#39;</span>
        <span class="c1"># optional kibana4_dashbaord to link to a kibana dashbaord.  When using this, Tattle will add the times from the Tale into the dashboard link, note this works for kibana4 dashbaords only</span>
        <span class="n">kibana4_dashboard</span><span class="p">:</span> <span class="s1">&#39;http://kibana.company.com/app/kibana#/dashboard/OurAwesomeDashboard&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="multiple-tales">
<h2>Multiple Tales<a class="headerlink" href="#multiple-tales" title="Permalink to this headline">¶</a></h2>
<p>Its often useful to group Tales by their purpose.  For example, you might want to group your <cite>Nginx Access</cite> Tales together, your <cite>Nginx Error</cite> Tales sperately, and your <cite>Securelog</cite> Tales together.  Lets say we have 20 differnt <cite>Nginx</cite> Tales, and 10 different <cite>Securelog</cite> Tales; that would mean we would have have at least 30 seperate <cite>Tale</cite> <code class="docutils literal"><span class="pre">.yaml</span></code> files in our <code class="docutils literal"><span class="pre">$TATTLE_HOME/etc/tales</span></code> directory.  As you can imagine, the more you use Tattle, the more unwieldy this can get.</p>
<p>Luckily Tattle allows you to define multiple Tales in one <code class="docutils literal"><span class="pre">.yaml</span></code> file to alleviate this issue.  Using the example below, you can see how we grouped two <cite>Nginx</cite> Tales into one file.  There can be as many Tales as you want this one in one <code class="docutils literal"><span class="pre">yaml</span></code> file.</p>
<div class="section" id="syntax">
<h3>Syntax<a class="headerlink" href="#syntax" title="Permalink to this headline">¶</a></h3>
<p>multi_tale_example.yaml</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">tales</span><span class="p">:</span>
    <span class="o">-</span>
        <span class="o">&lt;</span><span class="n">tale</span> <span class="c1">#1&gt;</span>
    <span class="o">-</span>
        <span class="o">&lt;</span><span class="n">tale</span> <span class="c1">#2&gt;</span>
    <span class="o">-</span>
        <span class="o">&lt;</span><span class="n">tale</span> <span class="c1">#3&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="example-multi-tale">
<h3>Example Multi Tale<a class="headerlink" href="#example-multi-tale" title="Permalink to this headline">¶</a></h3>
<p>Example for NGINX logs</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">tales</span><span class="p">:</span>
    <span class="c1"># Tale 1</span>
    <span class="o">-</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;NGINX 502 Spike&quot;</span>
        <span class="n">description</span><span class="p">:</span> <span class="s2">&quot;A high number of 501&#39;s have occured in our NGINX logs&quot;</span>
        <span class="n">severity</span><span class="p">:</span> <span class="s2">&quot;Criticial&quot;</span>
        <span class="n">tql_query</span><span class="p">:</span> <span class="s2">&quot;status:502&quot;</span>
        <span class="n">index</span><span class="p">:</span> <span class="s2">&quot;nginx-access-*&quot;</span>
        <span class="n">enabled</span><span class="p">:</span> <span class="mi">1</span>
        <span class="n">schedule_interval</span><span class="p">:</span> <span class="s2">&quot;1m&quot;</span>
        <span class="n">timeperiod</span><span class="p">:</span>
            <span class="n">start</span><span class="p">:</span> <span class="s2">&quot;now-1m&quot;</span>
            <span class="n">end</span><span class="p">:</span> <span class="s2">&quot;now&quot;</span>
        <span class="n">alert</span><span class="p">:</span>
            <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;frequency&quot;</span>
            <span class="n">relation</span><span class="p">:</span> <span class="s2">&quot;ge&quot;</span>
            <span class="n">qty</span><span class="p">:</span> <span class="mi">10</span>
            <span class="n">realert</span><span class="p">:</span> <span class="s2">&quot;15m&quot;</span>
            <span class="n">return_matches</span><span class="p">:</span> <span class="n">false</span>
        <span class="n">action</span><span class="p">:</span>
            <span class="n">email</span><span class="p">:</span>
                <span class="n">enabled</span><span class="p">:</span> <span class="mi">1</span>
                <span class="n">to</span><span class="p">:</span> <span class="s1">&#39;alerts@mycompany.com&#39;</span>

    <span class="c1"># Tale 2</span>
    <span class="o">-</span>
        <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;NGINX 404 Spike&quot;</span>
        <span class="n">description</span><span class="p">:</span> <span class="s2">&quot;A high number of 404&#39;s have occured in our NGINX logs&quot;</span>
        <span class="n">severity</span><span class="p">:</span> <span class="s2">&quot;Medium&quot;</span>
        <span class="n">tql_query</span><span class="p">:</span> <span class="s2">&quot;status:404&quot;</span>
        <span class="n">index</span><span class="p">:</span> <span class="s2">&quot;nginx-access-*&quot;</span>
        <span class="n">enabled</span><span class="p">:</span> <span class="mi">1</span>
        <span class="n">schedule_interval</span><span class="p">:</span> <span class="s2">&quot;1m&quot;</span>
        <span class="n">timeperiod</span><span class="p">:</span>
            <span class="n">start</span><span class="p">:</span> <span class="s2">&quot;now-1m&quot;</span>
            <span class="n">end</span><span class="p">:</span> <span class="s2">&quot;now&quot;</span>
        <span class="n">alert</span><span class="p">:</span>
            <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;frequency&quot;</span>
            <span class="n">relation</span><span class="p">:</span> <span class="s2">&quot;ge&quot;</span>
            <span class="n">qty</span><span class="p">:</span> <span class="mi">400</span>
            <span class="n">realert</span><span class="p">:</span> <span class="s2">&quot;15m&quot;</span>
            <span class="n">return_matches</span><span class="p">:</span> <span class="n">false</span>
        <span class="n">action</span><span class="p">:</span>
            <span class="n">email</span><span class="p">:</span>
                <span class="n">enabled</span><span class="p">:</span> <span class="mi">1</span>
                <span class="n">to</span><span class="p">:</span> <span class="s1">&#39;alerts@mycompany.com&#39;</span>
            <span class="n">pagerduty</span><span class="p">:</span>
                <span class="n">enabled</span><span class="p">:</span> <span class="mi">1</span>
                <span class="n">service_key</span><span class="p">:</span> <span class="s2">&quot;TattleAlerts&quot;</span>
                <span class="n">once_per_match</span><span class="p">:</span>
                    <span class="n">match_key</span><span class="p">:</span> <span class="s2">&quot;key&quot;</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tql.html" class="btn btn-neutral float-right" title="Tattle Query Language (TQL)" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="install.html" class="btn btn-neutral" title="Getting Started - Install &amp; Setup" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Nick MacCarthy (nick@nickmaccarthy.com).

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'latest',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>